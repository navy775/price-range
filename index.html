import React, { useState } from "react";
import { Tabs, Tab, Card, CardContent, Input, Button, Label, Select, Table, TableHead, TableRow, TableHeaderCell, TableBody, TableCell } from "@/components/ui";

const calculateResults = (buyPrice, sellPrice, shares, feeRate, minFee, taxRate, feeDiscount) => {
  const results = [];
  for (let price = sellPrice + 5; price >= sellPrice - 5; price -= 0.5) {
    const tradeTax = Math.floor(price * shares * (taxRate / 100));
    const tradeFee = Math.max((price * shares * (feeRate / 1000) * (feeDiscount / 10)).toFixed(0), minFee);
    const totalBuyCost = buyPrice * shares + parseFloat(tradeFee);
    const totalSell = price * shares - tradeTax - parseFloat(tradeFee);
    const profit = totalSell - totalBuyCost;
    const returnRate = ((profit / totalBuyCost) * 100).toFixed(2);
    results.push({
      buy: buyPrice,
      sell: price,
      tax: tradeTax,
      fee: tradeFee,
      profit: profit.toFixed(0),
      returnRate: `${returnRate}%`,
    });
  }
  return results;
};

export default function ProfitCalculator() {
  const [activeTab, setActiveTab] = useState("daytrade");
  const [inputs, setInputs] = useState({
    buyPrice: "103",
    sellPrice: "108",
    shares: "1000",
    feeRate: "1.425",
    minFee: "20",
    taxRate: "0.3",
    feeDiscount: "10",
  });
  const [results, setResults] = useState([]);

  const handleInputChange = (e) => {
    setInputs({ ...inputs, [e.target.name]: e.target.value });
  };

  const handleCalculate = () => {
    const res = calculateResults(
      parseFloat(inputs.buyPrice),
      parseFloat(inputs.sellPrice),
      parseInt(inputs.shares),
      parseFloat(inputs.feeRate),
      parseInt(inputs.minFee),
      parseFloat(inputs.taxRate),
      parseFloat(inputs.feeDiscount)
    );
    setResults(res);
  };

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold text-center mb-4">損益試算器</h1>
      <Tabs defaultValue="daytrade" className="w-full mb-6">
        <Tab value="daytrade" onClick={() => setActiveTab("daytrade")} className={activeTab === "daytrade" ? "bg-blue-500 text-white" : "bg-gray-200"}>當沖試算</Tab>
        <Tab value="stock" onClick={() => setActiveTab("stock")} className={activeTab === "stock" ? "bg-blue-500 text-white" : "bg-gray-200"}>股票試算</Tab>
      </Tabs>

      <Card>
        <CardContent className="grid grid-cols-2 gap-4">
          <div>
            <Label>買入價格</Label>
            <Input name="buyPrice" value={inputs.buyPrice} onChange={handleInputChange} />
          </div>
          <div>
            <Label>賣出價格</Label>
            <Input name="sellPrice" value={inputs.sellPrice} onChange={handleInputChange} />
          </div>
          <div>
            <Label>股數</Label>
            <Input name="shares" value={inputs.shares} onChange={handleInputChange} />
          </div>
          <div>
            <Label>手續費率（千分之）</Label>
            <Input name="feeRate" value={inputs.feeRate} onChange={handleInputChange} />
          </div>
          <div>
            <Label>最低手續費（元）</Label>
            <Input name="minFee" value={inputs.minFee} onChange={handleInputChange} />
          </div>
          <div>
            <Label>交易稅率（%）</Label>
            <Input name="taxRate" value={inputs.taxRate} onChange={handleInputChange} />
          </div>
          <div>
            <Label>手續費折數</Label>
            <Input name="feeDiscount" value={inputs.feeDiscount} onChange={handleInputChange} />
          </div>
        </CardContent>
        <CardContent>
          <Button className="mt-4" onClick={handleCalculate}>開始試算</Button>
        </CardContent>
      </Card>

      {results.length > 0 && (
        <div className="mt-8">
          <Table>
            <TableHead>
              <TableRow>
                <TableHeaderCell>買入價</TableHeaderCell>
                <TableHeaderCell>賣出價</TableHeaderCell>
                <TableHeaderCell>交易稅</TableHeaderCell>
                <TableHeaderCell>手續費</TableHeaderCell>
                <TableHeaderCell>損益</TableHeaderCell>
                <TableHeaderCell>報酬率</TableHeaderCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {results.map((row, index) => (
                <TableRow key={index}>
                  <TableCell>{row.buy}</TableCell>
                  <TableCell>{row.sell}</TableCell>
                  <TableCell>{row.tax}</TableCell>
                  <TableCell>{row.fee}</TableCell>
                  <TableCell className={parseInt(row.profit) >= 0 ? "text-green-600" : "text-red-600"}>{row.profit}</TableCell>
                  <TableCell className={row.returnRate.startsWith("-") ? "text-red-600" : "text-green-600"}>{row.returnRate}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      )}
    </div>
  );
}
