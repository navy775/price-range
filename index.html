<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>股票試算工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
    .tab-button {
      @apply px-4 py-2 font-bold rounded-t-lg border border-b-0 cursor-pointer;
    }
    .tab-button.active {
      @apply bg-blue-600 text-white;
    }
    .tab-button.inactive {
      @apply bg-gray-100 text-gray-600 hover:bg-gray-200;
    }
  </style>
</head>
<body class="bg-blue-50 p-4 min-h-screen">
  <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl">
    <div class="flex justify-center space-x-4 border-b p-4">
      <button class="tab-button active" onclick="switchTab('intraday')">當沖試算器</button>
      <button class="tab-button inactive" onclick="switchTab('stock')">個股試算器</button>
      <button class="tab-button inactive" onclick="switchTab('warrant')">權證試算器</button>
      <button class="tab-button inactive" onclick="switchTab('odd')">零股試算器</button>
    </div>

    <div id="intraday" class="tab-content p-4"></div>
    <div id="stock" class="tab-content p-4 hidden"></div>
    <div id="warrant" class="tab-content p-4 hidden"></div>
    <div id="odd" class="tab-content p-4 hidden"></div>
  </div>

  <script>
    const tabs = ["intraday", "stock", "warrant", "odd"];
    const tabButtons = document.querySelectorAll(".tab-button");

    function switchTab(tabId) {
      tabs.forEach(id => {
        document.getElementById(id).classList.add("hidden");
        document.querySelector(`.tab-button[onclick="switchTab('${id}')"]`).classList.remove("active");
        document.querySelector(`.tab-button[onclick="switchTab('${id}')"]`).classList.add("inactive");
      });

      document.getElementById(tabId).classList.remove("hidden");
      document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.remove("inactive");
      document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add("active");

      if (!document.getElementById(tabId).hasChildNodes()) {
        renderCalculator(tabId);
      }
    }

    function getTickSize(price) {
      if (price < 10) return 0.01;
      if (price < 50) return 0.05;
      if (price < 100) return 0.1;
      if (price < 500) return 0.5;
      if (price < 1000) return 1;
      return 5;
    }

    function renderCalculator(type) {
      const container = document.getElementById(type);
      const defaultTax = type === 'warrant' ? 0.1 : (type === 'odd' ? 0.3 : 0.3);
      const defaultMin = type === 'odd' ? 1 : 20;

      container.innerHTML = `
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div><label>買入價格</label><input type="number" id="${type}_buy" class="w-full border p-2" value="100"></div>
          <div><label>股數</label><input type="number" id="${type}_shares" class="w-full border p-2" value="1000"></div>
          <div><label>手續費折數（輸入 5 代表五折）</label><input type="number" id="${type}_fee" class="w-full border p-2" value="5"></div>
          <div><label>最低手續費</label><input type="number" id="${type}_min" class="w-full border p-2" value="${defaultMin}"></div>
          <div><label>交易稅率（%）</label><input type="number" id="${type}_tax" class="w-full border p-2" value="${defaultTax}"></div>
          <div><label>交易方向</label>
            <select id="${type}_dir" class="w-full border p-2">
              <option value="long">作多</option>
              <option value="short">作空</option>
            </select>
          </div>
        </div>
        <div class="text-center">
          <button onclick="resetCalc('${type}')" class="bg-blue-600 text-white px-6 py-2 rounded">開始試算</button>
        </div>
        <div class="flex justify-center gap-4 mt-4">
          <button onclick="showMore('${type}', 'up')" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">顯示更高價格</button>
          <button onclick="showMore('${type}', 'down')" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">顯示更低價格</button>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full border text-center">
            <thead class="bg-blue-100">
              <tr>
                <th class="p-2">買入價</th>
                <th class="p-2">賣出價</th>
                <th class="p-2">交易稅</th>
                <th class="p-2">手續費</th>
                <th class="p-2">損益</th>
                <th class="p-2">報酬率</th>
              </tr>
            </thead>
            <tbody id="${type}_result" class="bg-white text-sm"></tbody>
          </table>
        </div>
      `;

      currentSteps[type] = 10;
      calculate(type);
    }

    const currentSteps = { intraday: 10, stock: 10, warrant: 10, odd: 10 };

    function resetCalc(type) {
      currentSteps[type] = 10;
      calculate(type);
    }

    function showMore(type, direction) {
      currentSteps[type] += 5;
      calculate(type);
    }

    function calculate(type) {
      const buy = parseFloat(document.getElementById(`${type}_buy`).value);
      const shares = parseInt(document.getElementById(`${type}_shares`).value);
      const feeRate = parseFloat(document.getElementById(`${type}_fee`).value) / 10;
      const minFee = parseFloat(document.getElementById(`${type}_min`).value);
      const taxRate = parseFloat(document.getElementById(`${type}_tax`).value) / 100;
      const direction = document.getElementById(`${type}_dir`).value;
      const tick = getTickSize(buy);

      const result = document.getElementById(`${type}_result`);
      result.innerHTML = '';

      let priceSteps = [];
      for (let i = -currentSteps[type]; i <= currentSteps[type]; i++) {
        let sell = +(buy + i * tick).toFixed(2);
        if (direction === 'short') sell = +(buy - i * tick).toFixed(2);
        priceSteps.push(sell);
      }
      if (direction === 'long') priceSteps.reverse();

      for (let sell of priceSteps) {
        const totalBuy = buy * shares;
        const totalSell = sell * shares;
        const tax = Math.floor(totalSell * taxRate);
        const fee = Math.max(minFee, Math.floor((totalBuy + totalSell) * 0.001425 * feeRate));
        const profit = direction === 'long'
          ? (totalSell - totalBuy - tax - fee)
          : (totalBuy - totalSell - tax - fee);
        const returnRate = (profit / totalBuy * 100).toFixed(2);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2">${buy}</td>
          <td class="p-2">${sell}</td>
          <td class="p-2">${tax}</td>
          <td class="p-2">${fee}</td>
          <td class="p-2 ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profit}</td>
          <td class="p-2 ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${returnRate}%</td>
        `;
        result.appendChild(row);
      }
    }

    // 預設載入第一頁
    renderCalculator("intraday");
  </script>
</body>
</html>
